rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: Check if user is authenticated
    function isAuth() {
      return request.auth != null;
    }

    // Helper: Check if user is admin (role field on their user doc)
    function isAdmin() {
      return isAuth() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }

    // Courses: anyone can read published; only admin can write
    match /courses/{courseId} {
      allow read: if true;
      allow write: if isAdmin();

      // Modules subcollection
      match /modules/{moduleId} {
        allow read: if true;
        allow write: if isAdmin();

        // Lessons subcollection
        match /lessons/{lessonId} {
          allow read: if true;
          allow write: if isAdmin();
        }
      }

      // History subcollection
      match /history/{historyId} {
        allow read: if isAdmin();
        allow write: if isAdmin();
      }
    }

    // Users: owner can read/write their own doc
    match /users/{uid} {
      allow read: if isAuth() && request.auth.uid == uid;
      allow write: if isAuth() && request.auth.uid == uid;

      // Purchases subcollection
      match /purchases/{purchaseId} {
        allow read: if isAuth() && request.auth.uid == uid;
        allow write: if isAuth() && request.auth.uid == uid;
      }

      // Progress subcollection
      match /progress/{courseId} {
        allow read: if isAuth() && request.auth.uid == uid;
        allow write: if isAuth() && request.auth.uid == uid;
      }
    }

    // Admin config: authenticated users can read; only admin can write
    match /config/admin {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
  }
}
